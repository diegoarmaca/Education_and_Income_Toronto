---
title: "Compairing Toronto Neighborhoods With The Highest And Lowest Income"
author: "Ke-li Chiu & Diego Mamanche Castellanos"
date: "23/01/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Importing libraries

```{r, echo=TRUE}
my_packages <- c("opendatatoronto", "dplyr", "ggplot2", "tidyr")

# For each of the 3 packages, check whether each one exists, and install if not
for (pkg in my_packages) {
  
  if (!pkg %in% installed.packages()) { 
    # If package is not installed, install it:
    install.packages(pkg)
  } 
}

# Importing libraries
library(opendatatoronto)
library(dplyr)
library(tidyr)
library(ggplot2)

```

## Finding the data


```{r, echo= TRUE}
# Search packages (this returns a table)
wellbeing_packages <- search_packages("Wellbeing")

# Print the table
wellbeing_packages

```



##First Data set

###Filtering the wellbeing demographic dataset

```{r, echo= TRUE}
wellbeing_demographics_package<- wellbeing_packages %>%
  filter(title == "Wellbeing Toronto - Demographics: NHS Indicators") # Only keep the row(s) where the title is "Wellbeing Toronto - Demographics: NHS Indicators"

```


List the names of the internal datasets

```{r, echo= TRUE}
list_package_resources(wellbeing_demographics_package)

```

Getting the information dataset called "demographics-nhs-indicators-2011" 

```{r, echo= TRUE}
demographic_indicators2011 <- wellbeing_demographics_package %>% # Start with the package 
  list_package_resources() %>% # List the resources in the package
  filter(name == "demographics-nhs-indicators-2011") %>% # Only keep the resource we want 
  get_resource()
```

Cleaning the column names using janitor::clean_names

```{r, echo=TRUE}
demographic_indicators2011 <-
  janitor::clean_names(demographic_indicators2011)

demographic_indicators2011
```

Selecting columns needed

```{r, echo= TRUE}
income_demographic2011 <- subset(demographic_indicators2011, select = c("hood_number", "median_after_tax_household_income", 'total_visible_minority_population', 'not_a_visible_minority'))

names(income_demographic2011)[names(income_demographic2011) == "hood_number"] <- "ID"

#income_demographic2011  <- as.data.frame(income_demographic2011)

income_demographic2011 <- income_demographic2011[income_demographic2011$ID != 'ID',]       

income_demographic2011
```

##Second dataset

Getting the information dataset called "education-nhs-indicators-2011" 


```{r, echo= TRUE}
education_indicators2011 <- wellbeing_demographics_package %>% # Start with the package 
  list_package_resources() %>% # List the resources in the package
  filter(name == "education-nhs-indicators-2011") %>% # Only keep the resource we want 
  get_resource()
```


Cleaning the column names using janitor::clean_names

```{r, echo=TRUE}
education_indicators2011 <-
  janitor::clean_names(education_indicators2011)

education_indicators2011
```

Extracting the neighbourhood code from the column "geography"

```{r}
edu_id <- extract(education_indicators2011, geography, into = "ID" , regex = "([(][0-9]+[)])")

edu_id <- extract(edu_id, ID, into = "ID" , regex = "([0-9]+)")

edu_id
```


##Third dataset

###Filterint the housing dataset in order to extract the names of each neighborhood.

```{r, echo= TRUE}
wellbeing_housing_package <- wellbeing_packages %>%
  filter(title == "Wellbeing Toronto - Housing") # Only keep the row(s) where the title is "Wellbeing Toronto - Demographics: NHS Indicators"

```


Extracting the package

```{r, echo= TRUE}
list_package_resources(wellbeing_housing_package)

```

Getting the information dataset called "wellbeing-toronto-housing"

```{r, echo= TRUE}
housing_indicators2011 <- wellbeing_housing_package %>% # Start with the package 
  list_package_resources() %>% # List the resources in the package
  filter(name == "wellbeing-toronto-housing") %>% # Only keep the resource we want 
  get_resource()

housing_indicators2011 <- housing_indicators2011$RawDataRef_2011

housing_indicators2011
```


Cleaning the column names using janitor::clean_names, and selecting columns needed

```{r}
housing_indicators2011 <- 
  janitor::clean_names(housing_indicators2011)

housing_indicators2011 <- subset(housing_indicators2011, select = c("neighbourhood_id", "neighbourhood"))

names(housing_indicators2011)[names(housing_indicators2011) == "neighbourhood_id"] <- "ID"


housing_indicators2011
```




##Merging all datasets

```{r}
merged_df <- merge(housing_indicators2011, income_demographic2011, by = 'ID')
merged_df <- merge(merged_df, edu_id, by = 'ID')

merged_df <- merged_df[,1:15]


merged_df


```

#Create Graph1 dataframe 

```{r}
#Create variable called values and calculate median, max, and mean
values <- c(median(as.numeric(merged_df$median_after_tax_household_income)), max(as.numeric(merged_df$median_after_tax_household_income)), min(as.numeric(merged_df$median_after_tax_household_income)))

#Create variable called neighborhoods, adding the names of the neighborhoods found in the variable "values"
neighborhoods <- c('Toronto Median', merged_df[which.max(merged_df$median_after_tax_household_income),]$neighbourhood, merged_df[which.min(merged_df$median_after_tax_household_income),]$neighbourhood)

#Create variable measures to clarify each row
measures <- c('median', 'max', 'min')

#Create the dataframe graph1_df to plot the values
graph1_df <- cbind.data.frame(measures, neighborhoods, values)
graph1_df

```


Plotting the graph

```{r}
ggplot(graph1_df, aes(x = neighborhoods, y = values)) + 
  # Specify that we want a bar graph:
  geom_col() + 
  # Add titles and axis labels:
  labs(title = "Neighborhoods with the Highest and Lowest median income, \nand Toronto median income", 
       x = "Neighborhood", 
       y = "Income") 

```

##Create graph2 dataframe

```{r}

#Calculate the median for column "median_after_tax_household_income"
#Note: In this case, the median is better due to outliers
  
toronto_median_income <- median(as.numeric(income_demographic2011$median_after_tax_household_income))
toronto_median_income

#Calculate mean for the rest of the columns
toronto_other_columns <-  mutate_all(merged_df[,4:15], as.numeric)
toronto_other_columns <- colMeans(toronto_other_columns)
toronto_other_columns <- as.data.frame(toronto_other_columns)
toronto_other_columns <- round(toronto_other_columns[,1])

toronto_other_columns
#Create graph2 dataframe
filtered_dataset <- filter(merged_df, neighbourhood %in% c(neighborhoods))
filtered_dataset <- add_row(filtered_dataset)

#Assign values to third row
filtered_dataset[3,2:3] <- c('Toronto', toronto_median_income)
filtered_dataset[3,4:15] <- toronto_other_columns

filtered_dataset

filtered_dataset <- mutate(filtered_dataset, less_than_diploma = high_school_diploma_or_equivalent + 
postsecondary_certificate_diploma_or_degree + 
apprenticeship_or_trades_certificate_or_diploma + 
college_cegep_or_other_non_university_certificate_or_diploma)

#Rename columns
filtered_dataset <- 
  rename(filtered_dataset, 
    median_income = median_after_tax_household_income,
    no_high_school = no_certificate_diploma_or_degree,
    above_bachelor = university_certificate_diploma_or_degree_above_bachelor_level,
    university_diploma = university_certificate_or_diploma_below_bachelor_level
    )


graph2_df <- select(filtered_dataset, neighbourhood, no_high_school, less_than_diploma, university_diploma, bachelors_degree, above_bachelor)


graph2_df

```

#Reshaping the dataset
```{r}

graph2_df <- gather(graph2_df, "study_level", "count_level", -1)

graph2_df

```

##Plotting Graph2

```{r}

ggplot(graph2_df, aes(x = neighbourhood, y = count_level, fill = study_level)) + 
  # Specify that we want a bar graph:
  geom_bar(stat="identity", position=position_dodge()) +
  #geom_text(aes(y=label_ypos, label=c('Bridle Path - Sunnybrook - York Mills', 'Regent Park', 'Toronto'))) +
  # Add titles and axis labels:
  labs(title = "Neighborhoods by study level", 
       x = "Neighborhood", 
       y = "Population") 

```

